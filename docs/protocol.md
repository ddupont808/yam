# Protocol Guide

> **⚠️ The yam protocol is still in the design phase as we work on the reference implemention ⚠️**

The following is an intro to the core concepts of yam. The yam network is offline-first and based upon the [Secure Scuttlebutt](https://ssbc.github.io/scuttlebutt-protocol-guide/) peer-to-peer communication protocol.

## Identities

To participate in the network, you first need an identity. These are cryptographic keypairs, currently Ed25519 keypairs

 - Your keypair can also be used to sign and encrypt messages, like PGP keys.
 - When you login on the web ui, a hash of your username and password is used for deterministic seeding of your private key. This allows you to have the same keypair across devices (and even offline), *at the expense of weak passwords prone to [brute-force attacks](https://en.wikipedia.org/wiki/Brute-force_attack).*
 - Every identity is associated with a feed, and a new identity is generated per transaction to create a private feed. As a result some people will have many identities.

## Feeds

Feeds are the main method of storing data. The yam network does not have a central feed such as a blockchain.

 - Feeds are append-only logs associated to a single identity, storing a list of digitally signed messages.
 - Each peer appends every message they publish to the end of their own local feed.
 - Peers also hold feeds of peers that they care about, enabling message replication in the network. 
 - Every message is digitally signed with a link to the previous message in the feed.

This setup allows you to easily verify a message's authenticity, and append-only sequencing makes asking for feed updates easy (e.g. "can I have any messages after message 4 for @Joe's Feed").

## Replication

Replication is about sharing updates (messages added to feeds) with other peers. With peers replicating the feeds they want, it's possible to get your message distributed across the entire network and persist globally. 

Network-wide replication also means an unprotected network can be taken down in a [Sybil attack](https://en.wikipedia.org/wiki/Sybil_attack). To protect replication from abuse, peers keep a social trust graph along with Monero transaction proofs. A peer that can pass these checks may request other peers replicate their feed.

### Social Trust
 - You can follow interesting peers to automatically replicate their feeds.
 - When a peer follows another, they can publicly announce the feed they just followed. Your client can arrange this into a follow graph, and may want to use this to expand their local network:
![](https://soapdog.github.io/scuttlebutt-protocol-guide/img/follow_graph.png)

With social trust, a connection to the Monero network isn't a hard requirement for participating in yam's network. However, connecting yam to a Monero node allows the yam network to function even when you cannot trust anyone:

### Economic Barriers
 - Peers can generate new identities and feeds each time they create an order or product listing.
 - Since Monero fees are small, a private transaction can be made that references the feed without having to spend a significant amount of XMR.
 - If the creator of the feed wants the feed to be public, they can generate a [transaction proof-of-burn](https://monerodocs.org/interacting/monero-wallet-rpc-reference/#get_tx_proof) to share with other peers.
 - Peers that receive valid proofs replicate the associated feed and [gossip](https://en.wikipedia.org/wiki/Gossip_protocol) the proof, epidemically replicating it to the entire network.

The identity of any involved party is kept private throughout this entire process, and peers who try to start gossip with unspendable or invalid proofs can quickly be blocked from the network.

Monero's untamperable timestamp on every transaction proof makes it easy for peers to prune or ignore old feeds, keeping network-wide data usage low.

## Orders

The order protocol works like this:

1. Placing the order: The customer sends the funds to a temporary wallet generated by their yam client, a small amount going towards a proof-of-burn so an encrypted feed can be made. The feed logs [multisig](#multisig) info, private notes, and updates.
3. Accepting the order: The vendor uses the multisig info in the feed to put the order funds into a 2-of-3 joint account. At this point the order is considered accepted by both parties and the vendor can safely perform the shipment.
4. Finalizing the order: The customer recieves their item. They finalize the order to release the funds into the vendor's wallet, and leaves a review on the product's feed that is digitally signed by the proof-of-burn.

> ⚠ Immediately after the seller accepts the order, an "auto-finalize" timer starts. This timer counts down from 2 weeks. When the timer hits `00:00:00`, ***the order funds are automatically and irreversibly released to the seller***. When your order arrives, you should **Finalize Early** so the seller receives the funds in a timely fashion. If you order has yet to arrive, you can **Extend Finalize Timer** during the last 48 hours to keep your funds protected in escrow. 

If you do not believe the seller is fulfilling their side of the order, the yam network provides a method of [Dispute Resolution](#dispute-resolution). This process allows you to use an arbitrator to resolve order disputes, but must be done before finalization, when the funds are still secured in a multisig address.

> **Note:** Unless the vendor accepts the order during step 2, the customer will be able to cancel their order and reclaim their funds at any time during this process, no arbitrator is needed for this action.

## Multisig

> ⚠ Multisig is opt-out. Multisig provides protection for both the buyer and the seller. Only disable multisig if you understand it places your funds at risk of theft.

During an order, the funds are temporarily locked in a [2-of-3 joint account](https://monerodocs.org/multisignature/). Funds in such an account have to be cosigned by two of the three owners to be spent. The cosigners will be the buyer, the seller, and a trusted third party escrow.

All included cases and their cosigners can be seen below:

| Escalated? | Buyer | Seller | Escrow    | Funds recipient | Purpose
|-----------|-------|--------|-----------|------------------|---------
|           |       | 🔑     | 🔑        | Seller          | Order auto-finalize timer expired
|           | 🔑    |        | 🔑        | Seller          | Buyer finalized early
|           | 🔑    | 🔑     |           | Buyer           | Seller cancelled & refunded order
| ✓         | 🔑    |        | 🔑        | Buyer           | Arbitrator called, sided with buyer
| ✓         |       | 🔑     | 🔑        | Seller          | Arbitrator called, sided with seller

You can read more about multisignature accounts at: https://monerodocs.org/multisignature/

# Dispute Resolution

Occasionally you may run into problems during an order. At this stage you may want to initiate dispute resolution. Since 2 signers are needed to release funds locked in a 2-of-3 address, disputes use an arbitrator enable the release of locked funds.

This occurs as a 2-step process:

1. On the order page, click **Help with Order**. A private chat will be opened with the seller where you may try to get help directly. The seller may refund the order or find some other resolution.

2. If necessary, you can escalate the dispute. The escrow service will permit an arbitrator to cosign on their behalf, and the involved parties can discuss the dispute in a private feed. If this discussion doesn't resolve the dispute on its own, the arbitrator can choose to refund the order or finalize it early. 